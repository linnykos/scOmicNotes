<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8&nbsp; Single-cell CRISPR editting – scOmicNotes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter8_lineage.html" rel="next">
<link href="./chapter6_dna.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter7_crispr.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Single-cell CRISPR editting</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">scOmicNotes</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter1_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter2_sequencing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Single-cell sequencing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter3_rna.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Single-cell RNA-sequencing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter4_protein.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">‘Single-cell’ proteomics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter5_epigenetics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Single-cell epigenetics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter6_dna.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">‘Single-cell’ DNA</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter7_crispr.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Single-cell CRISPR editting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter8_lineage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Single-cell lineage tracing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter9_spatial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">‘Single-cell’ spatial transcriptomics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-chapter_7_basics" id="toc-sec-chapter_7_basics" class="nav-link active" data-scroll-target="#sec-chapter_7_basics"><span class="header-section-number">8.1</span> Basics of how CRISPR works</a>
  <ul>
  <li><a href="#a-bit-about-the-mechanism-of-double-stranded-dna-cleavage-by-cas9-in-a-crispr-knockout." id="toc-a-bit-about-the-mechanism-of-double-stranded-dna-cleavage-by-cas9-in-a-crispr-knockout." class="nav-link" data-scroll-target="#a-bit-about-the-mechanism-of-double-stranded-dna-cleavage-by-cas9-in-a-crispr-knockout."><span class="header-section-number">8.1.0.1</span> A bit about the mechanism of double-stranded DNA cleavage by Cas9 in a CRISPR knockout.</a></li>
  <li><a href="#crispr-in-the-wet-lab-design-and-delivery" id="toc-crispr-in-the-wet-lab-design-and-delivery" class="nav-link" data-scroll-target="#crispr-in-the-wet-lab-design-and-delivery"><span class="header-section-number">8.1.1</span> CRISPR in the wet lab: Design and delivery</a>
  <ul class="collapse">
  <li><a href="#commonly-used-cells." id="toc-commonly-used-cells." class="nav-link" data-scroll-target="#commonly-used-cells."><span class="header-section-number">8.1.1.1</span> Commonly used cells.</a></li>
  </ul></li>
  <li><a href="#the-jungle-of-crispr-crispr-ko-crispri-and-crispra" id="toc-the-jungle-of-crispr-crispr-ko-crispri-and-crispra" class="nav-link" data-scroll-target="#the-jungle-of-crispr-crispr-ko-crispri-and-crispra"><span class="header-section-number">8.1.2</span> The jungle of CRISPR: CRISPR-KO, CRISPRi, and CRISPRa</a></li>
  <li><a href="#crispr-screens-and-single-cell-gene-expression-analysis" id="toc-crispr-screens-and-single-cell-gene-expression-analysis" class="nav-link" data-scroll-target="#crispr-screens-and-single-cell-gene-expression-analysis"><span class="header-section-number">8.1.3</span> CRISPR screens and single-cell gene expression analysis</a></li>
  <li><a href="#interpreting-crispr-data-and-experimental-considerations" id="toc-interpreting-crispr-data-and-experimental-considerations" class="nav-link" data-scroll-target="#interpreting-crispr-data-and-experimental-considerations"><span class="header-section-number">8.1.4</span> Interpreting CRISPR data and experimental considerations</a>
  <ul class="collapse">
  <li><a href="#more-considerations-and-readings-about-crispr." id="toc-more-considerations-and-readings-about-crispr." class="nav-link" data-scroll-target="#more-considerations-and-readings-about-crispr."><span class="header-section-number">8.1.4.1</span> More considerations and readings about CRISPR.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-chapter_7_link" id="toc-sec-chapter_7_link" class="nav-link" data-scroll-target="#sec-chapter_7_link"><span class="header-section-number">8.2</span> Linking gRNA (i.e., perturbations) to its downstream genes</a>
  <ul>
  <li><a href="#a-typical-choice-sceptre." id="toc-a-typical-choice-sceptre." class="nav-link" data-scroll-target="#a-typical-choice-sceptre."><span class="header-section-number">8.2.0.1</span> A typical choice: SCEPTRE.</a></li>
  </ul></li>
  <li><a href="#estimating-gene-pathways-impacted-by-a-group-of-perturbations" id="toc-estimating-gene-pathways-impacted-by-a-group-of-perturbations" class="nav-link" data-scroll-target="#estimating-gene-pathways-impacted-by-a-group-of-perturbations"><span class="header-section-number">8.3</span> Estimating gene pathways impacted by a group of perturbations</a>
  <ul>
  <li><a href="#a-current-choice-gsfa." id="toc-a-current-choice-gsfa." class="nav-link" data-scroll-target="#a-current-choice-gsfa."><span class="header-section-number">8.3.0.1</span> A current choice: GSFA.</a></li>
  <li><a href="#a-brief-note-about-other-work." id="toc-a-brief-note-about-other-work." class="nav-link" data-scroll-target="#a-brief-note-about-other-work."><span class="header-section-number">8.3.0.2</span> A brief note about other work.</a></li>
  </ul></li>
  <li><a href="#prediction-perturbation-effects-for-crispr-screens-but-other-types-of-perturbations-as-well" id="toc-prediction-perturbation-effects-for-crispr-screens-but-other-types-of-perturbations-as-well" class="nav-link" data-scroll-target="#prediction-perturbation-effects-for-crispr-screens-but-other-types-of-perturbations-as-well"><span class="header-section-number">8.4</span> Prediction perturbation effects (for CRISPR screens, but other types of perturbations as well)</a>
  <ul>
  <li><a href="#hold-on-why-do-we-need-this-again" id="toc-hold-on-why-do-we-need-this-again" class="nav-link" data-scroll-target="#hold-on-why-do-we-need-this-again"><span class="header-section-number">8.4.0.1</span> Hold on… Why do we need this again?</a></li>
  <li><a href="#brief-aside-what-on-earth-is-a-normalizing-flow-neural-networks" id="toc-brief-aside-what-on-earth-is-a-normalizing-flow-neural-networks" class="nav-link" data-scroll-target="#brief-aside-what-on-earth-is-a-normalizing-flow-neural-networks"><span class="header-section-number">8.4.0.2</span> Brief aside: What on earth is a “normalizing flow neural networks”?</a></li>
  <li><a href="#state-of-the-art-research-perturbnet." id="toc-state-of-the-art-research-perturbnet." class="nav-link" data-scroll-target="#state-of-the-art-research-perturbnet."><span class="header-section-number">8.4.0.3</span> State-of-the-art research: PerturbNet.</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Single-cell CRISPR editting</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-chapter_7_basics" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="sec-chapter_7_basics"><span class="header-section-number">8.1</span> Basics of how CRISPR works</h2>
<p>The CRISPR-Cas system<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> is a powerful genome-editing technology that allows for precise modifications of DNA in a wide range of biological systems. Originally derived from the bacterial adaptive immune system, CRISPR-Cas9 has been repurposed for genetic engineering by using a guide RNA (gRNA) to direct the Cas9 nuclease to a specific genomic locus for targeted DNA cleavage. This section discusses how CRISPR is performed in the wet lab, different functional applications of CRISPR, and how CRISPR-based perturbations are analyzed in single-cell gene expression studies.</p>
<p>In a typical CRISPR screen experiment (mainly a CRISPR knockout), a library of lentivirus-packaged guide RNAs is introduced into cells under conditions designed to infect each cell with only one or a few sgRNAs (single guide RNA), see <a href="#fig-crispr-experiment1" class="quarto-xref">Figure&nbsp;<span>8.1</span></a> and <a href="#fig-crispr-experiment2" class="quarto-xref">Figure&nbsp;<span>8.2</span></a>. After selection to ensure stable integration, the cells are subjected to a particular stimulus such as drug treatment or other environmental challenge. Researchers then track the abundance of each sgRNA at the start and after the stimulus (for example, at day 0 and day 28) through next-generation sequencing. By comparing which sgRNAs become enriched or depleted, it is possible to discover genes essential for viability, pathways governing drug resistance, or other critical biological functions relevant to the phenotype under study, see <a href="#fig-crispr-cancer" class="quarto-xref">Figure&nbsp;<span>8.3</span></a>.</p>
<div class="block">
<div id="fig-crispr-experiment1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-experiment1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-experiment.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-experiment1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.1: Original from <span class="citation" data-cites="wei2019genome">Wei et al. (<a href="references.html#ref-wei2019genome" role="doc-biblioref">2019</a>)</span>, but this is directly from <a href="https://www.youtube.com/watch?v=JdCCl1uxCME" class="uri">https://www.youtube.com/watch?v=JdCCl1uxCME</a>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-crispr-experiment2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-experiment2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-experiment2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-experiment2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.2: From <a href="https://www.idtdna.com/pages/education/decoded/article/overview-what-is-crispr-screening" class="uri">https://www.idtdna.com/pages/education/decoded/article/overview-what-is-crispr-screening</a>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-crispr-cancer" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-cancer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-cancer.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-cancer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.3: From <span class="citation" data-cites="esposito2019hacking">Esposito et al. (<a href="references.html#ref-esposito2019hacking" role="doc-biblioref">2019</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<p><strong>Typical components of a CRISPR mechanism.</strong></p>
<ul>
<li><p><strong>Cas9 protein:</strong> A DNA endonuclease that recognizes and cuts target DNA specified by the guide RNA; variations include nuclease-deactivated (dCas9) or nickase Cas9 for alternative applications. Other CRISPR-associated proteins like Cas12a (Cpf1), Cas13, or dCas9 (dead Cas9) can expand the range of target sequences, have different PAM requirements, or allow for gene regulation without cutting DNA.<br>
Cas9 may bind sites with partial sequence complementarity, resulting in unintended cuts — this is called “off-target effects.” Various strategies (e.g., high-fidelity Cas9 variants, improved gRNA design) help minimize these effects.</p></li>
<li><p><strong>Guide RNA (gRNA):</strong> A customizable RNA sequence that directs Cas9 to the desired genomic locus; variations include single-guide RNA (sgRNA) and dual-RNA formats depending on the experimental design.<br>
To streamline CRISPR-Cas9 applications in genetic engineering, scientists have designed a synthetic fusion of crRNA and tracrRNA into a single-guide RNA (sgRNA). This chimeric RNA retains both the target-specific recognition (crRNA component) and Cas9-binding function (tracrRNA component) but simplifies the system by reducing the number of necessary molecules. sgRNAs are commonly used in research and therapeutic applications due to their ease of design and efficiency in genome editing.</p>
<ul>
<li><strong>crRNA (CRISPR RNA):</strong> A short RNA sequence that is complementary to the target DNA and provides sequence specificity for Cas9 binding. This is typically 20 nucleotides long.<br>
</li>
<li><strong>tracrRNA (Trans-activating CRISPR RNA):</strong> A structural RNA that base-pairs with the crRNA and interacts with Cas9 to activate its nuclease function.</li>
</ul>
<p>In this system, the crRNA and tracrRNA must form a duplex to guide Cas9 to the target sequence, which then leads to DNA cleavage.<br>
Multiple guide RNAs can be delivered simultaneously to target different loci at once, enabling complex genome-scale screens or combinatorial gene perturbations. Computational tools help optimize sgRNA sequences to maximize on-target efficiency while minimizing off-target effects. Chemically modified guide RNAs can improve stability and efficiency in vivo.</p></li>
<li><p><strong>PAM (Protospacer Adjacent Motif):</strong> A short DNA sequence adjacent to the target region that is essential for Cas9 to recognize and bind to DNA. The PAM sequence is typically “NGG” (where “N” represents any nucleotide, and “GG” is required). Without the correct PAM sequence, Cas9 cannot efficiently bind or cut the DNA, ensuring some level of specificity in genome editing. Different Cas9 variants have evolved or been engineered to recognize alternative PAM sequences, which offer broader targeting possibilities with reduced off-target effects. The cut typically happens 3 base-pairs upstream of the PAM on the target strand (i.e., in the 5′ direction).</p></li>
<li><p><strong>Lentivirus:</strong> Lentiviruses are widely used as viral vectors for delivering CRISPR components into cells (variations include different promoters, packaging systems, and envelope proteins to optimize transduction efficiency), particularly for experiments requiring stable and long-term expression of Cas9 and guide RNAs. Since many cell types are difficult to transfect using conventional methods, lentiviral transduction provides an efficient way to introduce CRISPR machinery into a broad range of cell types, including non-dividing and primary cells.</p>
<p>What is delivered to cells? (See <a href="#fig-plasmid1" class="quarto-xref">Figure&nbsp;<span>8.4</span></a> for the construction and architecture of the lentiviral vector.)</p>
<ul>
<li><strong>Cas9 expression construct:</strong> A lentiviral vector encoding the Cas9 nuclease under a suitable promoter. In some systems, inducible promoters (e.g., doxycycline-inducible) are used to control Cas9 activity.<br>
</li>
<li><strong>Guide RNA (gRNA) expression construct:</strong> A separate lentiviral vector encoding the guide RNA sequence under a promoter to ensure efficient transcription.<br>
</li>
<li><strong>Selection markers:</strong> Often, antibiotic resistance genes or fluorescent markers are included to facilitate selection of successfully transduced cells.</li>
</ul>
<p>Lentiviral delivery is essential for CRISPR applications due to its ability to stably integrate into the host genome, ensuring long-term expression of Cas9 and guide RNAs. This stability is particularly advantageous for genome-wide CRISPR knockout screens and lineage-tracing experiments. Additionally, many cell types, such as primary cells, stem cells, and immune cells, are notoriously difficult to transfect<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>; lentiviral transduction provides a more efficient and reliable alternative. See <a href="#fig-lentiviral1" class="quarto-xref">Figure&nbsp;<span>8.7</span></a> for how the gRNA can be injected into the cell, or if it’s integrated into the DNA, how it “borrows” the cell’s transcriptional machinery.</p></li>
</ul>
<div class="block">
<div id="fig-plasmid1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plasmid1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/grna-construction.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plasmid1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.4: (Top) From <span class="citation" data-cites="khan2022crispr">Khan et al. (<a href="references.html#ref-khan2022crispr" role="doc-biblioref">2022</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-plasmid2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plasmid2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/plasmid.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plasmid2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.5: (Bottom left) <a href="https://bpsbioscience.com/pd-1-crispr-cas9-lentivirus-integrating-78052" class="uri">https://bpsbioscience.com/pd-1-crispr-cas9-lentivirus-integrating-78052</a>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-plasmid3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plasmid3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/plasmid2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plasmid3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.6: (Bottom right) From <span class="citation" data-cites="mao2017heritability">Mao, Botella, and Zhu (<a href="references.html#ref-mao2017heritability" role="doc-biblioref">2017</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-lentiviral1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lentiviral1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/plasmid-integration.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lentiviral1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.7: (Left) <a href="https://www.benchling.com/blog/how-to-synthesize-your-grnas-for-crispr" class="uri">https://www.benchling.com/blog/how-to-synthesize-your-grnas-for-crispr</a>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-lentiviral2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lentiviral2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/lentiviral.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lentiviral2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.8: (Right) <a href="https://bpsbioscience.com/lentiviruses?product_type_filter=5567" class="uri">https://bpsbioscience.com/lentiviruses?product_type_filter=5567</a>.
</figcaption>
</figure>
</div>
</div>
<section id="a-bit-about-the-mechanism-of-double-stranded-dna-cleavage-by-cas9-in-a-crispr-knockout." class="level4" data-number="8.1.0.1">
<h4 data-number="8.1.0.1" class="anchored" data-anchor-id="a-bit-about-the-mechanism-of-double-stranded-dna-cleavage-by-cas9-in-a-crispr-knockout."><span class="header-section-number">8.1.0.1</span> A bit about the mechanism of double-stranded DNA cleavage by Cas9 in a CRISPR knockout.</h4>
<p>Cas9-mediated DNA cleavage occurs in several distinct steps. The Cas9 scans the genome for a matching PAM sequence. Once a PAM is identified, the guide RNA (gRNA) pairs with the complementary DNA strand. The actual cleavage of DNA is catalyzed by two distinct nuclease domains within Cas9: the <em>RuvC</em> domain, which cuts the non-complementary (non-target) DNA strand, and the <em>HNH</em> domain, which cuts the complementary (target) strand. These coordinated cleavages result in a <em>double-strand break (DSB)</em>, typically occurring 3-4 nucleotides upstream of the PAM sequence. This precise cleavage mechanism allows for highly specific genome modifications.</p>
<p>Once the double-strand break is generated, the cell must repair the damage. The two primary DNA repair mechanisms are <em>Non-Homologous End Joining (NHEJ)</em> and <em>Homology-Directed Repair (HDR)</em>. NHEJ is the default repair pathway in most cells and often introduces small insertions or deletions (indels) at the cut site, leading to gene disruptions. HDR, on the other hand, allows for precise DNA modifications when a donor DNA template is provided, making it a key mechanism for precise genome editing. Understanding the role of PAM sequences and the cleavage process is critical for designing effective CRISPR-based genetic modifications.</p>
<p>See <a href="#fig-crispr-pooled" class="quarto-xref">Figure&nbsp;<span>8.9</span></a> for variations of a CRISPR screen. What we’re discussing more in this chapter is a pooled CRISPR screen.</p>
<div class="block">
<div id="fig-crispr-pooled" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-pooled-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-pooled.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-pooled-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.9: From <span class="citation" data-cites="bock2022high">Bock et al. (<a href="references.html#ref-bock2022high" role="doc-biblioref">2022</a>)</span>. Note: Not all CRISPR screens are necessarily at the single-cell level, and it’s possible that no “gene expression” is measured. In the simplest CRISPR analyses, you are simply counting which gRNAs are most enriched (across the entire petri dish) after applying a stress to the cells.
</figcaption>
</figure>
</div>
</div>
</section>
<section id="crispr-in-the-wet-lab-design-and-delivery" class="level3" data-number="8.1.1">
<h3 data-number="8.1.1" class="anchored" data-anchor-id="crispr-in-the-wet-lab-design-and-delivery"><span class="header-section-number">8.1.1</span> CRISPR in the wet lab: Design and delivery</h3>
<p>CRISPR experiments begin with the design of a single-guide RNA (sgRNA) that matches the target DNA sequence adjacent to a protospacer-adjacent motif (PAM), which is required for Cas9 recognition and cleavage. The choice of target site is crucial, as off-target effects can lead to unintended mutations. Computational tools such as <code>CRISPOR</code> <span class="citation" data-cites="concordet2018crispor">(<a href="references.html#ref-concordet2018crispor" role="doc-biblioref">Concordet and Haeussler 2018</a>)</span> help predict sgRNA efficiency and minimize off-target binding.</p>
<p>Once the sgRNA is designed, it must be delivered into cells alongside the Cas9 enzyme. This can be achieved, such as using viral vectors such as lentivirus. Viral delivery is particularly useful for stable genome integration in cell populations, while other transient delivery methods allow for temporary gene editing effects. The choice of delivery method depends on the cell type, efficiency, and experimental goals. In single-cell studies, lentiviral vectors are often used to introduce a pooled library of sgRNAs, enabling large-scale CRISPR screens across thousands of individual cells.</p>
<section id="commonly-used-cells." class="level4" data-number="8.1.1.1">
<h4 data-number="8.1.1.1" class="anchored" data-anchor-id="commonly-used-cells."><span class="header-section-number">8.1.1.1</span> Commonly used cells.</h4>
<p>K562 cells, a human myelogenous leukemia cell line, are widely used in CRISPR screens due to their ease of culture, high transfection efficiency, and well-characterized genome. These cells exhibit an undifferentiated hematopoietic phenotype, making them a valuable model for studying gene regulation, hematopoiesis, and drug resistance. Their high proliferative capacity and ability to grow in suspension allow for efficient perturbation experiments at scale. Additionally, K562 cells have been used extensively in studies involving transcriptional regulation due to their rich chromatin accessibility data from ENCODE, which facilitates the identification of enhancer-gene interactions.</p>
<p>Another one I’ve seen quite often is Jurkat cells. This is a human T-cell leukemia cell line that serves as a model for immunology and T-cell signaling studies, often used in CRISPR screens focused on immune response and checkpoint regulation.</p>
<p>While CRISPR screens are widely applied in established cell lines, extending them to other cell types requires careful experimental planning. Primary cells and non-transformed cell types often have lower transfection or transduction efficiencies, necessitating optimization of delivery methods such as electroporation or viral transduction. Additionally, cell-type-specific chromatin accessibility and DNA repair mechanisms can influence CRISPR efficiency and editing outcomes, requiring tailored guide RNA design and validation. Growth rate and population doubling time must also be considered, as slow-dividing or non-dividing cells may require prolonged selection periods or alternative screening strategies, such as inducible CRISPR systems. Finally, proper negative controls and lineage-specific reference datasets are critical to ensure accurate interpretation of perturbation effects in novel cellular contexts. While most CRISPR screens are done <em>in vitro</em>, there are also technical challenges (which can be controlled for) for <em>in vivo</em> systems, see <a href="#fig-crispr-invivo" class="quarto-xref">Figure&nbsp;<span>8.10</span></a>.</p>
<div class="block">
<div id="fig-crispr-invivo" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-invivo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-invivo.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-invivo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.10: From <span class="citation" data-cites="kuhn2021moving">Kuhn, Santinha, and Platt (<a href="references.html#ref-kuhn2021moving" role="doc-biblioref">2021</a>)</span>.
</figcaption>
</figure>
</div>
</div>
</section>
</section>
<section id="the-jungle-of-crispr-crispr-ko-crispri-and-crispra" class="level3" data-number="8.1.2">
<h3 data-number="8.1.2" class="anchored" data-anchor-id="the-jungle-of-crispr-crispr-ko-crispri-and-crispra"><span class="header-section-number">8.1.2</span> The jungle of CRISPR: CRISPR-KO, CRISPRi, and CRISPRa</h3>
<p>CRISPR can be adapted for different functional purposes beyond simple gene knockout (KO). CRISPR-knockout (CRISPR-KO) involves the use of Cas9 to introduce double-stranded breaks at the target locus, leading to insertions or deletions (indels) that disrupt gene function, which is mainly what we’ve discussed above. This method is widely used for loss-of-function studies to investigate gene essentiality and pathway regulation.</p>
<p>In contrast, CRISPR activation (CRISPRa) and CRISPR interference (CRISPRi) enable gene expression modulation without altering the DNA sequence. CRISPRa employs a catalytically inactive Cas9 (dCas9) fused to transcriptional activators to enhance gene expression. Conversely, CRISPRi uses dCas9 fused to repressive domains such as KRAB to inhibit transcription. These methods allow for fine-tuned control over gene expression levels, making them particularly useful for studying gene regulatory networks at the single-cell level.</p>
<p>See <a href="#fig-crispr-types2" class="quarto-xref">Figure&nbsp;<span>8.11</span></a> and <a href="#fig-crispr-types" class="quarto-xref">Figure&nbsp;<span>8.12</span></a> for examples of variations of CRISPR screens.</p>
<div class="block">
<div id="fig-crispr-types2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-types2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-types2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-types2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.11: From <span class="citation" data-cites="esposito2019hacking">Esposito et al. (<a href="references.html#ref-esposito2019hacking" role="doc-biblioref">2019</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-crispr-types" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-types.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.12: From <span class="citation" data-cites="bock2022high">Bock et al. (<a href="references.html#ref-bock2022high" role="doc-biblioref">2022</a>)</span>.
</figcaption>
</figure>
</div>
</div>
</section>
<section id="crispr-screens-and-single-cell-gene-expression-analysis" class="level3" data-number="8.1.3">
<h3 data-number="8.1.3" class="anchored" data-anchor-id="crispr-screens-and-single-cell-gene-expression-analysis"><span class="header-section-number">8.1.3</span> CRISPR screens and single-cell gene expression analysis</h3>
<p>CRISPR screening is a high-throughput approach that uses pooled single-guide RNA (sgRNA) libraries to systematically perturb thousands of genes in a single experiment. There are two main types of CRISPR screens: <strong>positive selection screens</strong>, which identify sgRNAs that promote cell survival or proliferation, and <strong>negative selection screens</strong>, which identify essential genes by tracking sgRNAs that are depleted over time. When combined with single-cell RNA sequencing (scRNA-seq), CRISPR screens can reveal gene regulatory interactions at the resolution of individual cells, enabling functional genomics studies at an unprecedented scale. See <a href="#fig-crispr-workflow" class="quarto-xref">Figure&nbsp;<span>8.13</span></a> for the bulk-level analysis that does <em>not</em> include RNA-sequencing – this is to give you a sense of the simplistic CRISPR analysis.</p>
<div class="block">
<div id="fig-crispr-workflow" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-workflow.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.13: From <span class="citation" data-cites="bock2022high">Bock et al. (<a href="references.html#ref-bock2022high" role="doc-biblioref">2022</a>)</span>. This is an example of a bulk-level analysis that does <em>not</em> include RNA-sequencing.
</figcaption>
</figure>
</div>
</div>
<p>To analyze CRISPR perturbations in a single-cell context, cells are first transduced with a pooled sgRNA library, followed by scRNA-seq to capture transcriptomic changes. The identity of the sgRNA in each cell must also be determined in order to link gene perturbations to expression changes. This is typically done through targeted sequencing of the sgRNA cassette embedded in the transcriptome. However, sequencing the guide RNAs presents a challenge because they lack poly-A tails, which are typically required for capture in common scRNA-seq protocols. To overcome this, specialized methods such as <strong>Perturb-seq</strong> <span class="citation" data-cites="dixit2016perturb">(<a href="references.html#ref-dixit2016perturb" role="doc-biblioref">Dixit et al. 2016</a>)</span> and <strong>CROP-seq</strong> <span class="citation" data-cites="datlinger2017pooled">(<a href="references.html#ref-datlinger2017pooled" role="doc-biblioref">Datlinger et al. 2017</a>)</span> incorporate modifications to ensure efficient capture of sgRNA sequences. For example, Perturb-seq integrates the sgRNA into a polyadenylated transcript, allowing it to be captured along with mRNA molecules during reverse transcription.</p>
<p>Computational tools, which we will discuss in <a href="#sec-chapter_7_link" class="quarto-xref"><span>Section 8.2</span></a>, are commonly used to analyze CRISPR screen data by linking sgRNA-induced perturbations to gene expression changes. These tools help identify differentially expressed genes in response to specific genetic perturbations, revealing functional interactions within cellular networks. By combining CRISPR-based gene perturbation with single-cell transcriptomics, researchers can systematically dissect gene function, uncover regulatory networks, and study cellular heterogeneity in response to genetic modifications.</p>
</section>
<section id="interpreting-crispr-data-and-experimental-considerations" class="level3" data-number="8.1.4">
<h3 data-number="8.1.4" class="anchored" data-anchor-id="interpreting-crispr-data-and-experimental-considerations"><span class="header-section-number">8.1.4</span> Interpreting CRISPR data and experimental considerations</h3>
<p>CRISPR datasets in single-cell studies typically consist of expression matrices where each row corresponds to a gene and each column represents a cell, with additional metadata indicating the sgRNA assigned to each cell. One key challenge in analyzing these datasets is ensuring that each cell receives a single sgRNA, as multiple perturbations can introduce confounding effects. Additionally, technical noise in single-cell RNA sequencing, such as dropout events and variability in sequencing depth, must be accounted for in downstream analyses.</p>
<p>While CRISPR has revolutionized functional genomics, several caveats remain. Off-target effects can complicate result interpretation, requiring careful validation with orthogonal approaches such as RNA interference (RNAi) or small molecule inhibitors. Moreover, certain genes may be difficult to perturb due to low sgRNA efficiency or compensation from redundant pathways.</p>
<section id="more-considerations-and-readings-about-crispr." class="level4" data-number="8.1.4.1">
<h4 data-number="8.1.4.1" class="anchored" data-anchor-id="more-considerations-and-readings-about-crispr."><span class="header-section-number">8.1.4.1</span> More considerations and readings about CRISPR.</h4>
<p>See <span class="citation" data-cites="bock2022high">Bock et al. (<a href="references.html#ref-bock2022high" role="doc-biblioref">2022</a>)</span> for an important checklist (Box 1) to give you a sense the complexities when setting up a CRISPR experiment. Also, keep in mind that many CRISPR experiments are <em>not</em> measuring single-cell gene expressions. However, also (as mentioned above), there are also many CRISPR protocols to measure various omics at single-cell resolution alongside the gRNAs, see <a href="#fig-crispr-multiome" class="quarto-xref">Figure&nbsp;<span>8.14</span></a>.</p>
<div class="block">
<div id="fig-crispr-multiome" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crispr-multiome-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/crispr-multiome.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crispr-multiome-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.14: From <span class="citation" data-cites="cheng2023massively">Cheng et al. (<a href="references.html#ref-cheng2023massively" role="doc-biblioref">2023</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<p>For more reading: - <a href="https://www.idtdna.com/pages/education/decoded/article/overview-what-is-crispr-screening" class="uri">https://www.idtdna.com/pages/education/decoded/article/overview-what-is-crispr-screening</a> is probably one of the most helpful webpages I came across.</p>
</section>
</section>
</section>
<section id="sec-chapter_7_link" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="sec-chapter_7_link"><span class="header-section-number">8.2</span> Linking gRNA (i.e., perturbations) to its downstream genes</h2>
<p>Understanding the causal relationships between genetic perturbations and gene expression changes is a fundamental problem in genomics. Single-cell CRISPR screening technologies enable high-throughput profiling of transcriptomic changes induced by targeted genetic modifications at a single-cell resolution. The goal of the statistical analysis here is to identify genes whose expression levels are significantly altered by specific perturbations, providing insights into gene regulatory networks and functional genomics. However, accurately estimating these effects requires sophisticated statistical methodologies that can properly account for measurement noise, technical confounders, and the stochastic nature of gene expression.</p>
<p>A prototypical statistical model for this analysis is based on a generalized linear model (GLM) or a negative binomial regression framework, where gene expression levels are modeled as a function of perturbation status, along with potential confounders such as sequencing depth, batch effects, and cellular state, see <a href="#fig-glimmirs" class="quarto-xref">Figure&nbsp;<span>8.15</span></a>. Here are some statistical challenges a typical statistical method might account for:</p>
<ul>
<li><strong>Inferring which cells got which perturbation</strong>: Given that perturbations are not directly observed but inferred through guide RNA (gRNA) expression, a crucial modeling step involves using a measurement error framework or latent variable model to impute perturbation identities. The presence of background noise in gRNA detection complicates direct classification of perturbed versus unperturbed cells. See <a href="#fig-glm-eiv" class="quarto-xref">Figure&nbsp;<span>8.16</span></a>.</li>
<li><strong>Account for unmeasured confounders</strong>: Variations in sequencing efficiency or cell cycle effects (i.e., unmeasured biological processes that affect both the guide RNA and gene expression) can introduce spurious associations between perturbations and gene expression if not properly adjusted</li>
</ul>
<p>Fortunately, one experimental consideration we can use to advantage are negative control perturbations – perturbations that target non-functional genomic regions. These provide a null distribution against which true perturbation effects can be compared. Certain methods can use the negative controls to calibrate the p-values, while others use the negative controls to validate their control of false discovery rates.</p>
<div class="block">
<div id="fig-glimmirs" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-glimmirs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/glimmirs.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-glimmirs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.15: From <span class="citation" data-cites="zhou2024analysis">J. L. Zhou et al. (<a href="references.html#ref-zhou2024analysis" role="doc-biblioref">2024</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-glm-eiv" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-glm-eiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/glm-eiv.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-glm-eiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.16: From <span class="citation" data-cites="barry2024exponential">Barry, Roeder, and Katsevich (<a href="references.html#ref-barry2024exponential" role="doc-biblioref">2024</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<p>The goal of this analysis is produce a p-value for every sgRNA (targeting an enhancer) and gene pair. This is often visualized a QQ-plot, shown in <a href="#fig-sceptre-neg-control" class="quarto-xref">Figure&nbsp;<span>8.17</span></a>.</p>
<div class="block">
<div id="fig-sceptre-neg-control" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sceptre-neg-control-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/sceptre-neg-control.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sceptre-neg-control-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.17: From <span class="citation" data-cites="barry2021sceptre">Barry et al. (<a href="references.html#ref-barry2021sceptre" role="doc-biblioref">2021</a>)</span>. All the points here are <em>negative controls</em>, meaning we do <em>not</em> expect biologically that the sgRNA should affect the gene. (Again, each point is a pair of sgRNA and gene.) Hence, a “good” result is one where all the p-values fall on the diagonal line (i.e., the expected quantiles of the null p-values match the observed quantiles).
</figcaption>
</figure>
</div>
</div>
<section id="a-typical-choice-sceptre." class="level4" data-number="8.2.0.1">
<h4 data-number="8.2.0.1" class="anchored" data-anchor-id="a-typical-choice-sceptre."><span class="header-section-number">8.2.0.1</span> A typical choice: SCEPTRE.</h4>
<p>SCEPTRE <span class="citation" data-cites="barry2021sceptre">(<a href="references.html#ref-barry2021sceptre" role="doc-biblioref">Barry et al. 2021</a>)</span> (Analysis of single-cell perturbation screens via conditional resampling) is a statistical method designed to analyze gene-gRNA associations in single-cell CRISPR screens. It distinguishes true regulatory relationships from spurious ones by properly accounting for confounding technical factors and by circumventing strict parametric assumptions.</p>
<div class="block3">
<p><strong>Input/Output.</strong> The input to SCEPTRE is a 1) single-cell gene expression count matrix <span class="math inline">\(Y\in \mathbb{Z}_+^{n\times p}\)</span> for <span class="math inline">\(n\)</span> cells and <span class="math inline">\(p\)</span> genes, and 2) a single-cell guide RNA count matrix of the same <span class="math inline">\(n\)</span> cells, <span class="math inline">\(X \in \{0,1\}^{n\times d}\)</span> for <span class="math inline">\(d\)</span> perturbations. The output is a pairing between certain <span class="math inline">\(k\)</span> perturbations and <span class="math inline">\(p\)</span> genes (not necessarily one-to-one) with associated p-values. We can screen these p-values for significant ones after multiple-testing correction to determine which perturbations are associated (but not necessarily statistically causal in this method) with which genes.</p>
</div>
<div class="block2">
<p><strong>Are the guide RNAs measured as binary or counts?</strong><br>
SCEPTRE “thresholds” the gRNA count matrix to be a binary matrix (i.e., which cells received which perturbation). However, in reality, this information is itself sequenced and can be noisy. The authors then wrote a follow-up paper called GLM-EIV <span class="citation" data-cites="barry2024exponential">(<a href="references.html#ref-barry2024exponential" role="doc-biblioref">Barry, Roeder, and Katsevich 2024</a>)</span> to further account for this.</p>
</div>
<p>We describe the main components of SCEPTRE below. See <a href="#fig-sceptre" class="quarto-xref">Figure&nbsp;<span>8.18</span></a> for an illustration of this method.</p>
<ul>
<li><p><strong>Input Data.</strong> Let <span class="math inline">\(n\)</span> be the number of cells, <span class="math inline">\(p\)</span> the number of genes, and <span class="math inline">\(k\)</span> the number of gRNAs. The gene expression data can be represented by an <span class="math inline">\(n \times p\)</span> matrix, where each entry <span class="math inline">\(Y_{ij}\)</span> is the observed count (for instance, UMI count) of gene <span class="math inline">\(j\)</span> in cell <span class="math inline">\(i\)</span>. The gRNA detection data can be represented by an <span class="math inline">\(n \times d\)</span> binary matrix, where each entry <span class="math inline">\(X_{ik}\)</span> indicates whether gRNA <span class="math inline">\(k\)</span> was observed in cell <span class="math inline">\(i\)</span> (commonly treated as a binary indicator). In addition, each cell <span class="math inline">\(i\)</span> has a vector of technical covariates <span class="math inline">\(Z_i \in \mathbb{R}^r\)</span> (for instance, capturing batch, sequencing depth, or other factors). These covariates are crucial, as they can affect both the probability of detecting a given gRNA and the observed gene expression counts.</p></li>
<li><p><strong>Negative Binomial Expression Model.</strong> To test the association between a particular gene <span class="math inline">\(j\)</span> and gRNA <span class="math inline">\(k\)</span> (typically within 1 Mb apart), consider one-dimensional slices <span class="math inline">\(Y_i\)</span> and <span class="math inline">\(X_i\)</span>, denoting that cell <span class="math inline">\(i\)</span> has count <span class="math inline">\(Y_i\)</span> for gene <span class="math inline">\(j\)</span> and <span class="math inline">\(X_i \in \{0,1\}\)</span> for gRNA <span class="math inline">\(k\)</span>. A typical regression model is</p></li>
</ul>
<p><span class="math display">\[
Y_i \sim \mathrm{NegBin}(\mu_i, \alpha),
\quad
\log(\mu_i) = \beta_0 + \beta \, X_i + \gamma^\top Z_i,
\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span> is a dispersion parameter, <span class="math inline">\(\beta\)</span> measures how the presence of the gRNA (<span class="math inline">\(X_i\)</span>) shifts the mean expression <span class="math inline">\(\mu_i\)</span>, and <span class="math inline">\(\gamma\)</span> captures the effect of the technical covariates. Fitting this negative binomial regression provides a test statistic, for example a <span class="math inline">\(z\)</span>-score <span class="math inline">\(T = \beta / \text{SE}(\beta)\)</span>, that quantifies the strength of the association between <span class="math inline">\(X_i\)</span> and <span class="math inline">\(Y_i\)</span>.</p>
<ul>
<li><strong>Logistic Model for gRNA Detection.</strong> A key insight in SCEPTRE is that <span class="math inline">\(X_i\)</span> itself is subject to measurement variability and is influenced by the same covariates <span class="math inline">\(Z_i\)</span>. This can be modeled via</li>
</ul>
<p><span class="math display">\[
\pi_i = P(X_i = 1 \mid Z_i),
\quad
\log\!\Bigl(\frac{\pi_i}{1 - \pi_i}\Bigr)
= \tau_0 + \tau^\top Z_i.
\]</span></p>
<p>Fitting this logistic model to the observed gRNA indicators provides estimated probabilities <span class="math inline">\(\hat{\pi}_i\)</span> for each cell.</p>
<ul>
<li><strong>Conditional Resampling.</strong> SCEPTRE constructs an empirical null distribution by repeatedly resampling “fake” gRNA indicators <span class="math inline">\(\tilde{X}_i\)</span> in each cell, drawn independently from <span class="math inline">\(\mathrm{Bernoulli}(\hat{\pi}_i)\)</span>. In each resampled dataset, one holds <span class="math inline">\(Y_i\)</span> and <span class="math inline">\(Z_i\)</span> fixed but replaces the original <span class="math inline">\(X_i\)</span> with <span class="math inline">\(\tilde{X}_i\)</span>. For each resample, one refits the negative binomial regression (using an efficient shortcut) to compute a new test statistic <span class="math inline">\(\tilde{T}\)</span>. The empirical distribution of these <span class="math inline">\(\tilde{T}\)</span> values represents how the test statistic would behave under the null hypothesis (no real regulatory effect) but with confounders preserved. The SCEPTRE <span class="math inline">\(p\)</span>-value compares the actual test statistic <span class="math inline">\(T\)</span> against this resampling-based distribution, thus ensuring valid inference even if the negative binomial model for <span class="math inline">\(Y_i\)</span> is not perfectly specified.</li>
</ul>
<p>This is a common statistical trick. Essentially, the idea is: we constructing “fake” gRNA data that accounts for the technical factors but we are guaranteed to not relate to gene expression (thanks to how we sampled this fake data). Then, we can use this “fake” data to see what the typical estimated relation between the gRNA and gene is. We deem a gRNA and gene as a significant pair if the estimated relation is stronger than this “fake” distribution.</p>
<div class="block">
<div id="fig-sceptre" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sceptre-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/sceptre.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sceptre-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.18: From <span class="citation" data-cites="barry2021sceptre">Barry et al. (<a href="references.html#ref-barry2021sceptre" role="doc-biblioref">2021</a>)</span>.
</figcaption>
</figure>
</div>
</div>
</section>
</section>
<section id="estimating-gene-pathways-impacted-by-a-group-of-perturbations" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="estimating-gene-pathways-impacted-by-a-group-of-perturbations"><span class="header-section-number">8.3</span> Estimating gene pathways impacted by a group of perturbations</h2>
<p>Understanding the impact of CRISPR-based genetic perturbations on gene expression requires methods that can accurately capture coordinated transcriptional responses. Rather than affecting single genes in isolation, many perturbations influence entire regulatory networks or gene modules. Grouping genes and guide RNAs (gRNAs) into functional modules provides a structured framework to infer how perturbations propagate through cellular pathways, enhancing the ability to detect meaningful biological signals. See <span class="citation" data-cites="dixit2016perturb">Dixit et al. (<a href="references.html#ref-dixit2016perturb" role="doc-biblioref">2016</a>)</span> and <span class="citation" data-cites="schnitzler2024convergence">Schnitzler et al. (<a href="references.html#ref-schnitzler2024convergence" role="doc-biblioref">2024</a>)</span> for analyses that performed this type of analysis.</p>
<p>Biologically, grouping genes into modules is motivated by the observation that genetic perturbations often target key regulatory elements such as transcription factors, chromatin remodelers, or signaling pathway components. These elements control multiple downstream genes, making it crucial to infer their collective effects rather than analyzing genes independently. Single-cell CRISPR screens allow for the systematic interrogation of gene regulatory networks, but sparsity in the data and limited per-perturbation cell numbers necessitate statistical techniques that integrate information across functionally related genes. Here are some statistical challenges (very similar to the ones introduced in <a href="#sec-chapter_7_link" class="quarto-xref"><span>Section 8.2</span></a>).</p>
<ul>
<li><p><strong>Sparse and noisy guides</strong>: Perturbation effects are often sparse, meaning that each perturbation affects only a subset of genes, necessitating regularized models that can extract meaningful structure from noisy data. Also, single-cell CRISPR screens require inference of perturbation identities, as not all cells successfully receive a gRNA, and sequencing-based methods introduce detection noise.</p></li>
<li><p><strong>Unmeasured confounders</strong>: Batch effects, cell cycle states, and sequencing depth variations, can obscure true biological signals, making it essential to employ factor models that account for these sources of variability.</p></li>
<li><p><strong>Higher MOI for cheaper sequencing costs</strong>: A complexity arises when analyzing interactions between perturbations. Many CRISPR screens employ pooled designs where multiple perturbations may be present within the same cell. This can introduce nonlinear effects or epistatic interactions, where the combined influence of two perturbations deviates from the sum of their individual effects. See <span class="citation" data-cites="yao2024scalable">Yao et al. (<a href="references.html#ref-yao2024scalable" role="doc-biblioref">2024</a>)</span> and <span class="citation" data-cites="lin2022nested">Lin et al. (<a href="references.html#ref-lin2022nested" role="doc-biblioref">2022</a>)</span> for some examples of this.</p></li>
</ul>
<section id="a-current-choice-gsfa." class="level4" data-number="8.3.0.1">
<h4 data-number="8.3.0.1" class="anchored" data-anchor-id="a-current-choice-gsfa."><span class="header-section-number">8.3.0.1</span> A current choice: GSFA.</h4>
<p>Guided Sparse Factor Analysis (GSFA) <span class="citation" data-cites="zhou2023new">(<a href="references.html#ref-zhou2023new" role="doc-biblioref">Y. Zhou et al. 2023</a>)</span> is a Bayesian approach to analyze single-cell CRISPR screens, where multiple genetic perturbations (gRNAs) and whole-transcriptome gene expression are measured across individual cells. Below is a concise description of its components, using more detailed notation. (There is no commonly agreed upon method for this analysis at this time. You should think of GSFA as a promising start of a sequence of research. Future methods might account for guide RNA efficiency, non-additive effects, bioinformatics between guide RNA and target genes, etc.)</p>
<div class="block3">
<p><strong>Input/Output.</strong> The input to GSFA is a 1) single-cell gene expression count matrix <span class="math inline">\(Y\in \mathbb{R}^{n\times p}\)</span> for <span class="math inline">\(n\)</span> cells and <span class="math inline">\(p\)</span> genes, and 2) a single-cell guide RNA count matrix of the same <span class="math inline">\(n\)</span> cells, <span class="math inline">\(G \in \{0,1\}^{n\times d}\)</span> for <span class="math inline">\(d\)</span> perturbations. Here, <span class="math inline">\(Y_{ij}\)</span> is the normalized expression of gene <span class="math inline">\(j\)</span> in cell <span class="math inline">\(i\)</span>. The output of GSFA are: 1) a matrix <span class="math inline">\(W \in \mathbb{R}^{p \times k}\)</span> that denotes which genes is in which module (i.e., latent factor), and 2) a matrix <span class="math inline">\(\beta \in \mathbb{R}^{d \times k}\)</span> that denotes which perturbation is in which module.</p>
</div>
<p>We describe the main components of GSFA below. See <a href="#fig-gsfa" class="quarto-xref">Figure&nbsp;<span>8.19</span></a> for an illustration of this method.</p>
<div class="block">
<div id="fig-gsfa" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gsfa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/gsfa.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gsfa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.19: From <span class="citation" data-cites="zhou2023new">Y. Zhou et al. (<a href="references.html#ref-zhou2023new" role="doc-biblioref">2023</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<ul>
<li><strong>Nested matrix factorization model</strong>: GSFA decomposes the expression matrix into latent factors <span class="math inline">\(Z\)</span> and gene loadings <span class="math inline">\(W\)</span>, while modeling how these factors depend on <span class="math inline">\(G\)</span>:</li>
</ul>
<p><span class="math display">\[
\underbrace{Y_{ij}}_{\text{Expression}}
=
\sum_{\ell=1}^k Z_{i\ell}\,W_{j\ell}
+
E_{ij},
\qquad
\underbrace{Z_{i\ell}}_{\text{Factors}}
=
\sum_{m=1}^d G_{im}\,\beta_{m\ell}
+
\phi_{i,k}.
\]</span></p>
<p>Here, <span class="math inline">\(k\)</span> is the number of latent factors, <span class="math inline">\(E_{ij}\)</span> is residual noise (often assumed Gaussian), and <span class="math inline">\(\phi_{i\ell}\)</span> is a Gaussian random term that captures variation in factor <span class="math inline">\(\ell\)</span> not explained by perturbations. The factors <span class="math inline">\(Z_{i\ell}\)</span> can be interpreted as “gene modules” or “principal axes” of variation in the single-cell data.</p>
<ul>
<li><p><strong>Sparse priors and Bayesian inference</strong>: Each perturbation <span class="math inline">\(m\)</span> is assumed to affect only a few latent factors, reflected in a sparse prior on the effect sizes <span class="math inline">\(\beta_{m\ell}\)</span>. Similarly, each factor <span class="math inline">\(\ell\)</span> is assumed to influence only a small subset of genes, reflected in a sparse prior on <span class="math inline">\(W_{j\ell}\)</span>. These priors impose the idea that genetic perturbations typically alter only a limited set of biological pathways. GSFA uses Gibbs sampling to draw from the posterior distributions of <span class="math inline">\(\beta_{m\ell}\)</span>, <span class="math inline">\(W_{j\ell}\)</span>, and <span class="math inline">\(Z_{i\ell}\)</span> given the observed data <span class="math inline">\((Y, G)\)</span>.</p></li>
<li><p><strong>Factor association</strong>: Once <span class="math inline">\(Z\)</span> and <span class="math inline">\(\beta\)</span> are estimated, GSFA identifies which gRNAs significantly shift which factors. The parameter <span class="math inline">\(\beta_{m\ell}\)</span> measures how strongly perturbation <span class="math inline">\(m\)</span> activates or represses factor <span class="math inline">\(\ell\)</span>. Posterior inclusion probabilities (PIPs) are computed to assess confidence in each <span class="math inline">\(\beta_{m\ell}\)</span> being nonzero.</p></li>
<li><p><strong>Gene-level effects</strong>: GSFA also summarizes the overall impact of perturbation <span class="math inline">\(m\)</span> on gene <span class="math inline">\(j\)</span>. Since perturbation <span class="math inline">\(m\)</span> can affect multiple factors, and each factor influences the expression of gene <span class="math inline">\(j\)</span>, the total effect is</p></li>
</ul>
<p><span class="math display">\[
\theta_{mj}
=
\sum_{\ell=1}^k \beta_{m\ell}\,W_{j\ell}.
\]</span></p>
<p>The distribution of <span class="math inline">\(\theta_{m,j}\)</span> is sampled under the model’s posterior, yielding an <em>LFSR</em> (local false sign rate) that quantifies significance and sign confidence of the perturbation’s effect on that gene.</p>
<p>In practice, GSFA is applied to single-cell CRISPR screen data as follows. First, one often transforms count data (for example, via deviance residuals) and centers/scales covariates. Next, one fits GSFA via Gibbs sampling, obtaining posterior samples of the factors, gene loadings, and perturbation-factor effects. The factor discovery step can reveal broad biological modules (cell-cycle, immune response, neuronal development, etc.), while the gene-level effect summaries <span class="math inline">\(\theta_{mj}\)</span> yield a differential expression–style list of significantly perturbed genes for each gRNA. By borrowing information across genes that move together, GSFA can be more sensitive than a naive single-gene test, and can better separate real signals from confounding or measurement noise.</p>
</section>
<section id="a-brief-note-about-other-work." class="level4" data-number="8.3.0.2">
<h4 data-number="8.3.0.2" class="anchored" data-anchor-id="a-brief-note-about-other-work."><span class="header-section-number">8.3.0.2</span> A brief note about other work.</h4>
<p><span class="citation" data-cites="schnitzler2024convergence">Schnitzler et al. (<a href="references.html#ref-schnitzler2024convergence" role="doc-biblioref">2024</a>)</span> demonstrates using CRISPR to link SNPs in a GWAS to the regulated genes. (This paper also mentions a consensus NMF, which illustrates a different variation of clustering genes by regulatory pathways.) <span class="citation" data-cites="yao2024scalable">Yao et al. (<a href="references.html#ref-yao2024scalable" role="doc-biblioref">2024</a>)</span> demonstrates a method to “unravel” the effect of each perturbation on genes in high MOI experiments, where there are multiple perturbations purposely placed in cell, or multiple cells purposely placed in each droplet.</p>
</section>
</section>
<section id="prediction-perturbation-effects-for-crispr-screens-but-other-types-of-perturbations-as-well" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="prediction-perturbation-effects-for-crispr-screens-but-other-types-of-perturbations-as-well"><span class="header-section-number">8.4</span> Prediction perturbation effects (for CRISPR screens, but other types of perturbations as well)</h2>
<p>A fundamental computational challenge in single-cell perturbation studies is predicting how a perturbation, such as a drug treatment or CRISPR-based genetic modification, affects cellular behavior. This challenge arises in two primary contexts: (1) given a perturbation applied to one cell type, where both control and perturbed states are observed, inferring how another cell type would respond to the same perturbation based on its unperturbed expression; or (2) disentangling the latent space of perturbations from the latent space of cell embeddings, allowing for generalizable predictions of perturbation effects even in the absence of direct observations. The latter approach leverages biological priors on perturbation relationships, enabling the extrapolation of perturbation effects across unseen conditions. Accurate prediction methods are crucial for understanding drug responses, genetic knockouts, and CRISPR-based enhancer perturbations, ultimately providing insights into gene regulatory networks and therapeutic interventions.</p>
<section id="hold-on-why-do-we-need-this-again" class="level4" data-number="8.4.0.1">
<h4 data-number="8.4.0.1" class="anchored" data-anchor-id="hold-on-why-do-we-need-this-again"><span class="header-section-number">8.4.0.1</span> Hold on… Why do we need this again?</h4>
<p>Remember: If we use a low MOI (ex: MOI of 0.3) experiment, we need <em>many</em> cells to receive each guide, and we <em>even more</em> cells because most cells won’t receive a guide. To quote <span class="citation" data-cites="bock2022high">Bock et al. (<a href="references.html#ref-bock2022high" role="doc-biblioref">2022</a>)</span>, ::: block “For both genome-scale and focused CRISPR knockout (CRISPRko) screens, it is advisable to include at least four different gRNAs for each target gene, although carefully designed and validated gRNA libraries with fewer gRNAs per gene can provide reliable results. All gRNA libraries should include gRNAs for application-specific positive and negative control genes, which are important to validate the screen. In addition, they should include control gRNAs that target known safe harbour loci or other genomic regions where no specific effects of gene editing are expected, in order to account for the DNA damage response and for non-specific reduction in cell proliferation caused by CRISPRko. …</p>
<p>As a guideline, we recommend a coverage of 100-200 cells per target gene for positive selection screens and 500-1,000 cells per target gene for negative selection screens.” :::</p>
<p>(The reason negative selection screens need more cells is because these cells will die from the stressor after the CRISPRko integration. So you need to be confident these cells really “died” (instead of you happening by bad luck to miss these cells during sequencing).)</p>
<p>For this reasons, some CRISPR experiments purposely use a high MOI (think of 10 to 50). This reduces the number of cells they need, since most cells will receive multiple guides. As one concrete example, see <span class="citation" data-cites="gasperini2019genome">Gasperini et al. (<a href="references.html#ref-gasperini2019genome" role="doc-biblioref">2019</a>)</span>, which performed a CRISPRi screen. They targeted 1,119 candidate enhancer elements (which was near 5,611 genes) in K562 cells, and used a high MOI (roughly 15) across 47,650 cells. This means, if they used a conservative MOI=1 (i.e., each cell receives only one guide), they would needed about <span class="math inline">\(47,650 \times 15 \approx 715,000\)</span> cells. (That would make that experiment a <em>massive</em> (and extremely expensive) single-cell experiments.)</p>
<p>However, the drawback of high MOI is that sometimes you cannot reasonably rule that different sgRNA doesn’t interact with one another. For this reason, we might wonder: Can we: 1) use a low MOI experiment, 2) leverage some biological insights about these sgRNA, and 3) develop a fancy computational tool to synthetically predict what the effects of the sgRNA we didn’t actually use are?</p>
</section>
<section id="brief-aside-what-on-earth-is-a-normalizing-flow-neural-networks" class="level4" data-number="8.4.0.2">
<h4 data-number="8.4.0.2" class="anchored" data-anchor-id="brief-aside-what-on-earth-is-a-normalizing-flow-neural-networks"><span class="header-section-number">8.4.0.2</span> Brief aside: What on earth is a “normalizing flow neural networks”?</h4>
<p>Normalizing flow neural networks provide a framework to construct a rich, complex probability distribution by applying a series of <strong>invertible transformations</strong> to a simple base distribution (often a Gaussian), see <a href="#fig-normalizing_flow1" class="quarto-xref">Figure&nbsp;<span>8.20</span></a> and <a href="#fig-normalizing_flow2" class="quarto-xref">Figure&nbsp;<span>8.21</span></a>. Each transformation is designed to be bijective and differentiable, which ensures that the overall mapping from the latent space to the data space remains invertible. This property allows for exact likelihood evaluation, because the change of variables formula can be applied directly to the transformed distribution. In practice, one computes the log-likelihood of an observed sample by summing the log of the Jacobian determinant of each invertible mapping and the log-likelihood of the base distribution.</p>
<div class="block">
<div id="fig-normalizing_flow1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-normalizing_flow1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/normalizing_flow.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-normalizing_flow1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.20: From <a href="https://lilianweng.github.io/posts/2018-10-13-flow-models/" class="uri">https://lilianweng.github.io/posts/2018-10-13-flow-models/</a>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-normalizing_flow2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-normalizing_flow2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/normalizing_flow2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-normalizing_flow2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.21: From <a href="https://lilianweng.github.io/posts/2018-10-13-flow-models/" class="uri">https://lilianweng.github.io/posts/2018-10-13-flow-models/</a>.
</figcaption>
</figure>
</div>
</div>
<p>Invertibility is a key difference between normalizing flows and Variational Autoencoders (VAEs). In a VAE, an encoder approximates a posterior distribution over the latent variables, but it is generally not invertible. Consequently, VAEs compute a lower bound of the log-likelihood rather than the exact likelihood. In contrast, the invertible nature of normalizing flows enables direct calculation of the log-likelihood, thereby avoiding the need for variational approximations. This leads to more precise density estimation and can offer a clearer interpretation of how each layer transforms data.</p>
<p>Here is one concrete example of what a normalizing flow network is, which is called RealNVP (where NVP stands for “non-volume preserving”). RealNVP <span class="citation" data-cites="dinh2016density">(<a href="references.html#ref-dinh2016density" role="doc-biblioref">Dinh, Sohl-Dickstein, and Bengio 2016</a>)</span> is a type of invertible (or “normalizing flow”) model where each transformation can be inverted cheaply by design. The primary idea is to split the input vector <span class="math inline">\(\mathbf{x}\)</span> into two parts, keep one part unchanged (<span class="math inline">\(\mathbf{x}_1\)</span>), and transform the other part (<span class="math inline">\(\mathbf{x}_2\)</span>) in a way that is guaranteed to be invertible.</p>
<ul>
<li><strong>Coupling Layer</strong>: Partition <span class="math inline">\(\mathbf{x}\)</span> into <span class="math inline">\(\mathbf{x}_1\)</span> and <span class="math inline">\(\mathbf{x}_2\)</span>. Then, define the output <span class="math inline">\(\mathbf{y} = (\mathbf{y}_1, \mathbf{y}_2)\)</span> where <span class="math inline">\(\mathbf{y}_1 = \mathbf{x}_1\)</span> and</li>
</ul>
<p><span class="math display">\[
\mathbf{y}_2 = \mathbf{x}_2 \,\odot\, \exp\bigl(\mathbf{s}(\mathbf{x}_1)\bigr) + \mathbf{t}(\mathbf{x}_1).
\]</span></p>
<p>The functions <span class="math inline">\(\mathbf{s}(\cdot)\)</span> and <span class="math inline">\(\mathbf{t}(\cdot)\)</span> can be any neural networks that output real-valued vectors. The exponential ensures a nonzero scale factor, while addition by <span class="math inline">\(\mathbf{t}\)</span> is trivially invertible. See <a href="#fig-realnvp" class="quarto-xref">Figure&nbsp;<span>8.22</span></a>.</p>
<div class="block">
<div id="fig-realnvp" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-realnvp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/realnvp.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-realnvp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.22: From <span class="citation" data-cites="dinh2016density">Dinh, Sohl-Dickstein, and Bengio (<a href="references.html#ref-dinh2016density" role="doc-biblioref">2016</a>)</span>.
</figcaption>
</figure>
</div>
</div>
<ul>
<li><strong>Ensuring this transformation is invertible</strong>: The inverse of the above transformation is</li>
</ul>
<p><span class="math display">\[
\mathbf{x}_1 = \mathbf{y}_1, \quad
\mathbf{x}_2 = \bigl(\mathbf{y}_2 - \mathbf{t}(\mathbf{y}_1)\bigr) \,\odot\, \exp\bigl(-\mathbf{s}(\mathbf{y}_1)\bigr).
\]</span></p>
<p>Because <span class="math inline">\(\mathbf{x}_1\)</span> remains the same, it is straightforward to reconstruct <span class="math inline">\(\mathbf{x}_2\)</span>. No matter how <span class="math inline">\(\mathbf{s}\)</span> and <span class="math inline">\(\mathbf{t}\)</span> are learned, the coupling layer is invertible by construction.</p>
<p>Splitting the input and only transforming part of it guarantees efficient forward and inverse computations. By composing multiple coupling layers, we can create flexible density estimators while preserving tractable log-likelihood calculation.</p>
<p>See <a href="https://lilianweng.github.io/posts/2018-10-13-flow-models/" class="uri">https://lilianweng.github.io/posts/2018-10-13-flow-models/</a>, <a href="https://paperswithcode.com/method/affine-coupling" class="uri">https://paperswithcode.com/method/affine-coupling</a>, <a href="https://bjlkeng.io/posts/normalizing-flows-with-real-nvp/" class="uri">https://bjlkeng.io/posts/normalizing-flows-with-real-nvp/</a>, and <span class="citation" data-cites="kobyzev2020normalizing">Kobyzev, Prince, and Brubaker (<a href="references.html#ref-kobyzev2020normalizing" role="doc-biblioref">2020</a>)</span> for useful overviews about normalizing flows, with some details about the way to construct normalizing flows using affine transformations.</p>
<p>(Sidenote: This context is mainly only needed to understand PerturbNet <span class="citation" data-cites="yu2022perturbnet">(<a href="references.html#ref-yu2022perturbnet" role="doc-biblioref">Yu and Welch 2022</a>)</span>. There are plenty of methods to predict perturbation effects not build using normalizing flow networks. See scGen <span class="citation" data-cites="lotfollahi2019scgen">(<a href="references.html#ref-lotfollahi2019scgen" role="doc-biblioref">Lotfollahi, Wolf, and Theis 2019</a>)</span> for example, which is built on your more typical VAE architecture.)</p>
</section>
<section id="state-of-the-art-research-perturbnet." class="level4" data-number="8.4.0.3">
<h4 data-number="8.4.0.3" class="anchored" data-anchor-id="state-of-the-art-research-perturbnet."><span class="header-section-number">8.4.0.3</span> State-of-the-art research: PerturbNet.</h4>
<p>PerturbNet <span class="citation" data-cites="yu2022perturbnet">(<a href="references.html#ref-yu2022perturbnet" role="doc-biblioref">Yu and Welch 2022</a>)</span> is a deep generative framework that predicts single-cell gene expression responses under both observed and <em>unseen</em> chemical or genetic perturbations. That is, we want to predict the effect of perturbation <em>even if none of cells ever received this perturbation</em>.</p>
<div class="block3">
<p><strong>Input/Output.</strong> The input to PerturbNet (when trying to perturb the impact of CRISPRi perturbations) is a 1) single-cell gene expression count matrix <span class="math inline">\(\mathbb{Z}_+^{n\times p}\)</span> for <span class="math inline">\(n\)</span> cells and <span class="math inline">\(p\)</span> genes, 2) a single-cell guide RNA count matrix of the same <span class="math inline">\(n\)</span> cells, <span class="math inline">\(\{0,1\}^{n\times d}\)</span> for <span class="math inline">\(d\)</span> perturbations, and 3) a database that groups the perturbations (many of which might not the <span class="math inline">\(d\)</span> perturbations you actually measured) into pathways. The output is three things: 1) a VAE to embed each of the <span class="math inline">\(n\)</span> cells into low-dimensional space, 2) a VAE to embed each of the perturbations (including the <span class="math inline">\(d\)</span> in your dataset) into a low-dimensional space, and 3) a learned function that takes in a cell’s latent representation and perturbation’s latent representation and outputs the (predicted) cell’s latent representation after receiving that perturbation.</p>
</div>
<p>It is designed around three principal building blocks: (i) <em>perturbation representation networks</em>, (ii) <em>cell-state representation networks</em>, and (iii) a <em>conditional invertible neural network</em> (cINN) that translates perturbation embeddings into full distributions of cellular states.</p>
<ul>
<li><strong>Perturbation Representation Networks (GenotypeVAE or ESM)</strong>: To capture key features of chemical or genetic perturbations in a low-dimensional, learnable space, PerturbNet uses different encoder architectures. We’ll just focus on the CRISPR-related perturbations in our discussion here. For CRISPR knockdown or CRISPRi/a perturbations, a <em>GenotypeVAE</em> is used, which starts from a high-dimensional GO-term annotation vector for each target gene (or union of genes), then encodes this vector into a condensed gene-function latent space via fully-connected layers. In the case of coding-sequence edits (such as CRISPR knockouts which introduce changes to the genetics), perturbations are encoded by a <em>pretrained transformer</em> (e.g.&nbsp;ESM, which stands for “evolutionary scale modeling”<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>), which outputs a deterministic embedding of amino-acid sequences.</li>
</ul>
<p>The point is: we use biological insights about these perturbations (which use established databases) to learn the “space of perturbations.” See <a href="#fig-perturbnet21" class="quarto-xref">Figure&nbsp;<span>8.23</span></a> and <a href="#fig-perturbnet22" class="quarto-xref">Figure&nbsp;<span>8.24</span></a>.</p>
<div class="block">
<div id="fig-perturbnet21" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-perturbnet21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/perturbnet2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-perturbnet21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.23: From <span class="citation" data-cites="yu2022perturbnet">Yu and Welch (<a href="references.html#ref-yu2022perturbnet" role="doc-biblioref">2022</a>)</span>. GenotypeVAE to learn a low-dimensional representation for each gene based on which pathways it is known to be involved in.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-perturbnet22" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-perturbnet22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/perturbnet3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-perturbnet22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.24: From <span class="citation" data-cites="yu2022perturbnet">Yu and Welch (<a href="references.html#ref-yu2022perturbnet" role="doc-biblioref">2022</a>)</span>. ESM to learn a low-dimensional representation of the protein sequence (which is a “sequence of words” (language model).
</figcaption>
</figure>
</div>
</div>
<ul>
<li><p><strong>Cell-state representation network</strong>: Separately, PerturbNet learns a latent space for the single-cell gene expression profiles. This is similar to your typical VAE for scRNA-seq using a negative binomial-likelihood. Each cell is thus mapped into a latent space <span class="math inline">\(Z\)</span> capturing core variation in gene expression. The VAE decoder reconstructs the input (e.g.&nbsp;counts) from the sampled <span class="math inline">\(Z\)</span> latent, enabling distributional modeling of single-cell data.</p></li>
<li><p><strong>Conditional invertible neural network (cINN)</strong>: [[This is where the magic happens!]] The crux of PerturbNet is a <em>conditional invertible neural network</em>, denoted <span class="math inline">\(Z=f(V \mid Y)\)</span>. (This is where the normalizing flow comes into play.) Here, <span class="math inline">\(Y\)</span> is the perturbation’s latent embedding (from GenotypeVAE or ESM), and <span class="math inline">\(Z\)</span> is the cell-state latent (from the cell VAE). The cINN incorporates a “residual” variable <span class="math inline">\(V \sim N(0,I)\)</span>, capturing per-cell variability unexplained by the perturbation. In plain English, you want learn the function <span class="math inline">\(f\)</span> that takes in as input <span class="math inline">\(V\)</span> (the “baseline” representation of the cell), and then condition to a perturbation (represented by <span class="math inline">\(Y\)</span>) to give you the observed gene expression (which here, is a low-dimensional embedding represented by <span class="math inline">\(Z\)</span>).</p></li>
</ul>
<p>Concretely, <span class="math inline">\(f\)</span> is built from <em>affine coupling blocks</em> (see <a href="#fig-realnvp" class="quarto-xref">Figure&nbsp;<span>8.22</span></a>):</p>
<p><span class="math display">\[
(W_1, W_2) = \mathrm{Block}((U_1,U_2) \mid Y),
\]</span></p>
<p>where <span class="math inline">\(U_1,U_2\)</span> split the input, and each block’s parameters are learned via fully-connected sub-networks that shift and scale one part of the data conditioned on the other part and on <span class="math inline">\(Y\)</span>. Because each block is invertible (with a tractable Jacobian determinant), one can train <span class="math inline">\(f\)</span> from the objective<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p><span class="math display">\[
\mathcal{L} = \mathbb{E} \bigl[-\log p\{f^{-1}(Z \mid Y)\}\bigr] + \text{(constant terms)},
\]</span></p>
<p>driving <span class="math inline">\(f^{-1}\)</span> to map <span class="math inline">\((Z,Y)\)</span> back to a Gaussian <span class="math inline">\(V\)</span>. (I’m aware this probably doesn’t make a lot of sense since I’m not providing enough context about how a cINN works. See the references above about normalizing flows.)</p>
<p>This cINN architecture thus learns to sample realistic cell embeddings for each perturbation. In practice, a stack of multiple affine coupling blocks plus normalization layers is used, ensuring expressivity and stable training.</p>
<ul>
<li><strong>Training procedure and use</strong>: After the perturbation and cell VAEs are pre-trained (often on large unpaired datasets), one collects <em>paired</em> perturbation–cell data (e.g.&nbsp;a high-throughput Perturb-seq or chemical screen). By feeding the latent <span class="math inline">\(Y\)</span> from the perturbation network and the latent <span class="math inline">\(Z\)</span> from the cell-state VAE into the cINN, PerturbNet learns the probabilistic mapping between <span class="math inline">\(Y\)</span> and <span class="math inline">\(Z\)</span>. Once trained, it can (1) sample predicted single-cell states for a new perturbation <span class="math inline">\(Y_{\mathrm{new}}\)</span>, and (2) be inverted to find which perturbation embeddings shift cells toward a desired <span class="math inline">\(Z_{\mathrm{target}}\)</span> distribution.</li>
</ul>
<p>Putting this all together, see <a href="#fig-perturbnet11" class="quarto-xref">Figure&nbsp;<span>8.25</span></a> and <a href="#fig-perturbnet12" class="quarto-xref">Figure&nbsp;<span>8.26</span></a>.</p>
<div class="block">
<div id="fig-perturbnet11" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-perturbnet11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/perturbnet1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-perturbnet11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.25: From <span class="citation" data-cites="yu2022perturbnet">Yu and Welch (<a href="references.html#ref-yu2022perturbnet" role="doc-biblioref">2022</a>)</span>. High-level idea.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-perturbnet12" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-perturbnet12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/perturbnet4.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-perturbnet12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.26: From <span class="citation" data-cites="yu2022perturbnet">Yu and Welch (<a href="references.html#ref-yu2022perturbnet" role="doc-biblioref">2022</a>)</span>. More details about how this works.
</figcaption>
</figure>
</div>
</div>
<p><strong>Typical components of a CRISPR mechanism.</strong></p>
<ul>
<li><p><strong>Cas9 protein:</strong> A DNA endonuclease that recognizes and cuts target DNA specified by the guide RNA; variations include nuclease-deactivated (dCas9) or nickase Cas9 for alternative applications. Other CRISPR-associated proteins like Cas12a (Cpf1), Cas13, or dCas9 (dead Cas9) can expand the range of target sequences, have different PAM requirements, or allow for gene regulation without cutting DNA.<br>
Cas9 may bind sites with partial sequence complementarity, resulting in unintended cuts — this is called “off-target effects.” Various strategies (e.g., high-fidelity Cas9 variants, improved gRNA design) help minimize these effects.</p></li>
<li><p><strong>Guide RNA (gRNA):</strong> A customizable RNA sequence that directs Cas9 to the desired genomic locus; variations include single-guide RNA (sgRNA) and dual-RNA formats depending on the experimental design.<br>
To streamline CRISPR-Cas9 applications in genetic engineering, scientists have designed a synthetic fusion of crRNA and tracrRNA into a single-guide RNA (sgRNA). This chimeric RNA retains both the target-specific recognition (crRNA component) and Cas9-binding function (tracrRNA component) but simplifies the system by reducing the number of necessary molecules. sgRNAs are commonly used in research and therapeutic applications due to their ease of design and efficiency in genome editing.</p>
<ul>
<li><strong>crRNA (CRISPR RNA):</strong> A short RNA sequence that is complementary to the target DNA and provides sequence specificity for Cas9 binding. This is typically 20 nucleotides long.<br>
</li>
<li><strong>tracrRNA (Trans-activating CRISPR RNA):</strong> A structural RNA that base-pairs with the crRNA and interacts with Cas9 to activate its nuclease function.<br>
In this system, the crRNA and tracrRNA must form a duplex to guide Cas9 to the target sequence, which then leads to DNA cleavage.<br>
Multiple guide RNAs can be delivered simultaneously to target different loci at once, enabling complex genome-scale screens or combinatorial gene perturbations. Computational tools help optimize sgRNA sequences to maximize on-target efficiency while minimizing off-target effects. Chemically modified guide RNAs can improve stability and efficiency in vivo.</li>
</ul></li>
<li><p><strong>PAM (Protospacer Adjacent Motif):</strong> A short DNA sequence adjacent to the target region that is essential for Cas9 to recognize and bind to DNA. The PAM sequence is typically “NGG” (where “N” represents any nucleotide, and “GG” is required). Without the correct PAM sequence, Cas9 cannot efficiently bind or cut the DNA, ensuring some level of specificity in genome editing. Different Cas9 variants have evolved or been engineered to recognize alternative PAM sequences, which offer broader targeting possibilities with reduced off-target effects. The cut typically happens 3 base pairs upstream of the PAM on the target strand (i.e., in the 5′ direction).</p></li>
<li><p><strong>Lentivirus:</strong> Lentiviruses are widely used as viral vectors for delivering CRISPR components into cells (variations include different promoters, packaging systems, and envelope proteins to optimize transduction efficiency), particularly for experiments requiring stable and long-term expression of Cas9 and guide RNAs. Since many cell types are difficult to transfect using conventional methods, lentiviral transduction provides an efficient way to introduce CRISPR machinery into a broad range of cell types, including non-dividing and primary cells.<br>
What is delivered to cells? (See <a href="#fig-plasmid1" class="quarto-xref">Figure&nbsp;<span>8.4</span></a>–<a href="#fig-plasmid3" class="quarto-xref">Figure&nbsp;<span>8.6</span></a> for the construction and architecture of the lentiviral vector.)</p>
<ul>
<li><strong>Cas9 expression construct:</strong> A lentiviral vector encoding the Cas9 nuclease under a suitable promoter. In some systems, inducible promoters (e.g., doxycycline-inducible) are used to control Cas9 activity.<br>
</li>
<li><strong>Guide RNA (gRNA) expression construct:</strong> A separate lentiviral vector encoding the guide RNA sequence under a promoter to ensure efficient transcription.<br>
</li>
<li><strong>Selection markers:</strong> Often, antibiotic resistance genes or fluorescent markers are included to facilitate selection of successfully transduced cells.</li>
</ul>
<p>Lentiviral delivery is essential for CRISPR applications due to its ability to stably integrate into the host genome, ensuring long-term expression of Cas9 and guide RNAs. This stability is particularly advantageous for genome-wide CRISPR knockout screens and lineage tracing experiments. Additionally, many cell types, such as primary cells, stem cells, and immune cells, are notoriously difficult to transfect<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>; lentiviral transduction provides a more efficient and reliable alternative. See <a href="#fig-lentiviral1" class="quarto-xref">Figure&nbsp;<span>8.7</span></a>–<a href="#fig-lentiviral2" class="quarto-xref">Figure&nbsp;<span>8.8</span></a> for how the gRNA can be injected into the cell, or if it’s integrated into the DNA, how it “borrows” the cell’s transcriptional machinery.</p></li>
</ul>
<div class="block">
<div id="fig-plasmid1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plasmid1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/grna-construction.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plasmid1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.4: <em>Top</em>: From <span class="citation" data-cites="khan2022crispr">(<a href="references.html#ref-khan2022crispr" role="doc-biblioref"><strong>khan2022crispr?</strong></a>)</span>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-plasmid2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plasmid2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/plasmid.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plasmid2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.5: <em>Bottom left</em>: <a href="https://bpsbioscience.com/pd-1-crispr-cas9-lentivirus-integrating-78052" class="uri">https://bpsbioscience.com/pd-1-crispr-cas9-lentivirus-integrating-78052</a>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-plasmid3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plasmid3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/plasmid2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plasmid3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.6: <em>Bottom right</em>: From <span class="citation" data-cites="mao2017heritability">(<a href="references.html#ref-mao2017heritability" role="doc-biblioref"><strong>mao2017heritability?</strong></a>)</span>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-lentiviral1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lentiviral1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/plasmid-integration.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lentiviral1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.7: <em>Left</em>: <a href="https://www.benchling.com/blog/how-to-synthesize-your-grnas-for-crispr" class="uri">https://www.benchling.com/blog/how-to-synthesize-your-grnas-for-crispr</a>.
</figcaption>
</figure>
</div>
</div>
<div class="block">
<div id="fig-lentiviral2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lentiviral2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fig/chap7/lentiviral.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lentiviral2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.8: <em>Right</em>: <a href="https://bpsbioscience.com/lentiviruses?product_type_filter=5567" class="uri">https://bpsbioscience.com/lentiviruses?product_type_filter=5567</a>.
</figcaption>
</figure>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<<<<<<< HEAD
<div id="ref-barry2024exponential" class="csl-entry" role="listitem">
Barry, Timothy, Kathryn Roeder, and Eugene Katsevich. 2024. <span>“Exponential Family Measurement Error Models for Single-Cell CRISPR Screens.”</span> <em>Biostatistics</em> 25 (4): 1254–72.
</div>
<div id="ref-barry2021sceptre" class="csl-entry" role="listitem">
Barry, Timothy, Xuran Wang, John A Morris, Kathryn Roeder, and Eugene Katsevich. 2021. <span>“<span>SCEPTRE</span> Improves Calibration and Sensitivity in Single-Cell <span>CRISPR</span> Screen Analysis.”</span> <em>Genome Biology</em> 22 (1): 1–19.
</div>
<div id="ref-bock2022high" class="csl-entry" role="listitem">
Bock, Christoph, Paul Datlinger, Florence Chardon, Matthew A Coelho, Matthew B Dong, Keith A Lawson, Tian Lu, et al. 2022. <span>“High-Content CRISPR Screening.”</span> <em>Nature Reviews Methods Primers</em> 2 (1): 1–23.
</div>
<div id="ref-cheng2023massively" class="csl-entry" role="listitem">
Cheng, Junyun, Gaole Lin, Tianhao Wang, Yunzhu Wang, Wenbo Guo, Jie Liao, Penghui Yang, et al. 2023. <span>“Massively Parallel CRISPR-Based Genetic Perturbation Screening at Single-Cell Resolution.”</span> <em>Advanced Science</em> 10 (4): 2204484.
</div>
<div id="ref-concordet2018crispor" class="csl-entry" role="listitem">
Concordet, Jean-Paul, and Maximilian Haeussler. 2018. <span>“CRISPOR: Intuitive Guide Selection for CRISPR/Cas9 Genome Editing Experiments and Screens.”</span> <em>Nucleic Acids Research</em> 46 (W1): W242–45.
</div>
<div id="ref-datlinger2017pooled" class="csl-entry" role="listitem">
Datlinger, Paul, André F Rendeiro, Christian Schmidl, Thomas Krausgruber, Peter Traxler, Johanna Klughammer, Linda C Schuster, Amelie Kuchler, Donat Alpar, and Christoph Bock. 2017. <span>“Pooled CRISPR Screening with Single-Cell Transcriptome Readout.”</span> <em>Nature Methods</em> 14 (3): 297–301.
</div>
<div id="ref-dinh2016density" class="csl-entry" role="listitem">
Dinh, Laurent, Jascha Sohl-Dickstein, and Samy Bengio. 2016. <span>“Density Estimation Using Real Nvp.”</span> <em>arXiv Preprint arXiv:1605.08803</em>.
</div>
<div id="ref-dixit2016perturb" class="csl-entry" role="listitem">
Dixit, Atray, Oren Parnas, Biyu Li, Jenny Chen, Charles P Fulco, Livnat Jerby-Arnon, Nemanja D Marjanovic, et al. 2016. <span>“Perturb-Seq: Dissecting Molecular Circuits with Scalable Single-Cell RNA Profiling of Pooled Genetic Screens.”</span> <em>Cell</em> 167 (7): 1853–66.
</div>
<div id="ref-esposito2019hacking" class="csl-entry" role="listitem">
Esposito, Roberta, Núria Bosch, Andrés Lanzós, Taisia Polidori, Carlos Pulido-Quetglas, and Rory Johnson. 2019. <span>“Hacking the Cancer Genome: Profiling Therapeutically Actionable Long Non-Coding RNAs Using CRISPR-Cas9 Screening.”</span> <em>Cancer Cell</em> 35 (4): 545–57.
</div>
<div id="ref-gasperini2019genome" class="csl-entry" role="listitem">
Gasperini, Molly, Andrew J Hill, José L McFaline-Figueroa, Beth Martin, Seungsoo Kim, Melissa D Zhang, Dana Jackson, et al. 2019. <span>“A Genome-Wide Framework for Mapping Gene Regulation via Cellular Genetic Screens.”</span> <em>Cell</em> 176 (1): 377–90.
</div>
<div id="ref-khan2022crispr" class="csl-entry" role="listitem">
Khan, Faiza Shafique, Farhan Goher, Dapeng Zhang, Peng Shi, Zhiying Li, Yin Min Htwe, and Yong Wang. 2022. <span>“Is CRISPR/Cas9 a Way Forward to Fast-Track Genetic Improvement in Commercial Palms? Prospects and Limits.”</span> <em>Frontiers in Plant Science</em> 13: 1042828.
</div>
<div id="ref-kobyzev2020normalizing" class="csl-entry" role="listitem">
Kobyzev, Ivan, Simon JD Prince, and Marcus A Brubaker. 2020. <span>“Normalizing Flows: An Introduction and Review of Current Methods.”</span> <em>IEEE Transactions on Pattern Analysis and Machine Intelligence</em> 43 (11): 3964–79.
</div>
<div id="ref-kuhn2021moving" class="csl-entry" role="listitem">
Kuhn, Maria, António J Santinha, and Randall J Platt. 2021. <span>“Moving from in Vitro to in Vivo CRISPR Screens.”</span> <em>Gene and Genome Editing</em> 2: 100008.
</div>
<div id="ref-lin2022nested" class="csl-entry" role="listitem">
Lin, Xueqiu, Yanxia Liu, Shuai Liu, Xiang Zhu, Lingling Wu, Yanyu Zhu, Dehua Zhao, et al. 2022. <span>“Nested Epistasis Enhancer Networks for Robust Genome Regulation.”</span> <em>Science</em> 377 (6610): 1077–85.
</div>
<div id="ref-lotfollahi2019scgen" class="csl-entry" role="listitem">
Lotfollahi, Mohammad, F Alexander Wolf, and Fabian J Theis. 2019. <span>“scGen Predicts Single-Cell Perturbation Responses.”</span> <em>Nature Methods</em> 16 (8): 715–21.
</div>
<div id="ref-mao2017heritability" class="csl-entry" role="listitem">
Mao, Yanfei, Jose Ramon Botella, and Jian-Kang Zhu. 2017. <span>“Heritability of Targeted Gene Modifications Induced by Plant-Optimized CRISPR Systems.”</span> <em>Cellular and Molecular Life Sciences</em> 74 (6): 1075–93.
</div>
<div id="ref-schnitzler2024convergence" class="csl-entry" role="listitem">
Schnitzler, Gavin R, Helen Kang, Shi Fang, Ramcharan S Angom, Vivian S Lee-Kim, X Rosa Ma, Ronghao Zhou, et al. 2024. <span>“Convergence of Coronary Artery Disease Genes onto Endothelial Cell Programs.”</span> <em>Nature</em> 626 (8000): 799–807.
</div>
<div id="ref-wei2019genome" class="csl-entry" role="listitem">
Wei, Lai, Derek Lee, Cheuk-Ting Law, Misty Shuo Zhang, Jialing Shen, Don Wai-Ching Chin, Allen Zhang, et al. 2019. <span>“Genome-Wide CRISPR/Cas9 Library Screening Identified PHGDH as a Critical Driver for Sorafenib Resistance in HCC.”</span> <em>Nature Communications</em> 10 (1): 4681.
</div>
<div id="ref-yao2024scalable" class="csl-entry" role="listitem">
Yao, Douglas, Loic Binan, Jon Bezney, Brooke Simonton, Jahanara Freedman, Chris J Frangieh, Kushal Dey, et al. 2024. <span>“Scalable Genetic Screening for Regulatory Circuits Using Compressed Perturb-Seq.”</span> <em>Nature Biotechnology</em> 42 (8): 1282–95.
</div>
<div id="ref-yu2022perturbnet" class="csl-entry" role="listitem">
Yu, Hengshi, and Joshua D Welch. 2022. <span>“Perturbnet Predicts Single-Cell Responses to Unseen Chemical and Genetic Perturbations.”</span> <em>BioRxiv</em>, 2022–07.
</div>
<div id="ref-zhou2024analysis" class="csl-entry" role="listitem">
Zhou, Jessica L, Karthik Guruvayurappan, Shushan Toneyan, Hsiuyi V Chen, Aaron R Chen, Peter Koo, and Graham McVicker. 2024. <span>“Analysis of Single-Cell CRISPR Perturbations Indicates That Enhancers Predominantly Act Multiplicatively.”</span> <em>Cell Genomics</em> 4 (11).
</div>
<div id="ref-zhou2023new" class="csl-entry" role="listitem">
Zhou, Yifan, Kaixuan Luo, Lifan Liang, Mengjie Chen, and Xin He. 2023. <span>“A New Bayesian Factor Analysis Method Improves Detection of Genes and Biological Processes Affected by Perturbations in Single-Cell CRISPR Screening.”</span> <em>Nature Methods</em> 20 (11): 1693–703.
</div>
</div>
</section>
=======
<div id="ref-wei2019genome" class="csl-entry" role="listitem">
Wei, Lai, Derek Lee, Cheuk-Ting Law, Misty Shuo Zhang, Jialing Shen, Don Wai-Ching Chin, Allen Zhang, et al. 2019. <span>“Genome-Wide CRISPR/Cas9 Library Screening Identified PHGDH as a Critical Driver for Sorafenib Resistance in HCC.”</span> <em>Nature Communications</em> 10 (1): 4681.
</div>
</div>
>>>>>>> 1bd00352c0200b64b0ac3edb230ca1aa1aad83a8
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>CRISPR stands for “clustered regularly interspaced short palindromic repeats,” but it’s not too important to know why exactly it’s called this for the purposes of this chapter.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<<<<<<< HEAD
<li id="fn2"><p>Transfection is the process of introducing foreign nucleic acids (such as DNA or RNA) into eukaryotic cells to manipulate gene expression or enable genetic modifications. It is commonly used in plasmid-based CRISPR applications. In opposition, transduction refers to the introduction of genetic material using viral vectors..<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>This itself is fascinating. See <a href="https://github.com/facebookresearch/esm" class="uri">https://github.com/facebookresearch/esm</a>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Here, the probability <span class="math inline">\(p\)</span> is determining the likelihood <span class="math inline">\(f^{-1}(Z \mid Y)\)</span> originated from <span class="math inline">\(V \sim N(0,I)\)</span>. We’re going to approximate the expectation by taking an average of all the cells we’ve sequenced based on their latent embedding <span class="math inline">\(Z\)</span> and the latent embedding of the treatment <span class="math inline">\(Y\)</span> that was applied to that cell.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
=======
<li id="fn2"><p>Transfection is the process of introducing foreign nucleic acids (such as DNA or RNA) into eukaryotic cells to manipulate gene expression or enable genetic modifications. It is commonly used in plasmid-based CRISPR applications. In opposition, transduction refers to the introduction of genetic material using viral vectors.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
>>>>>>> 1bd00352c0200b64b0ac3edb230ca1aa1aad83a8
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter6_dna.html" class="pagination-link" aria-label="'Single-cell' DNA">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">‘Single-cell’ DNA</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter8_lineage.html" class="pagination-link" aria-label="Single-cell lineage tracing">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Single-cell lineage tracing</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>